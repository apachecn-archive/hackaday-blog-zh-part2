# 学习 Verilog For FPGAs:终于硬件了！

> 原文:[https://hack aday . com/2015/08/27/learning-verilog-for-FPGA-hardware-at-last/](https://hackaday.com/2015/08/27/learning-verilog-for-fpgas-hardware-at-last/)

进入 FPGA 设计并不是一次单一的经历。你必须弄清楚一个工具链，学会如何在设计过程中考虑硬件，并将其转化为工作日志。最终目标是把你的工作放到一个实际的硬件上，这就是这篇文章的全部内容。

在本系列的前两篇文章中，您构建了一个简单的 Verilog 演示[，它由一个加法器](http://hackaday.com/2015/08/19/learning-verilog-on-a-25-fpga-part-i/)和一个[基于触发器的电路](http://hackaday.com/2015/08/20/learning-verilog-for-fpgas-flip-flops/)组成。模拟工作，所以现在是时候把设计到一个真正的 FPGA，看看它是否在现实世界中工作。我们将使用的 FPGA 板是 Lattice iCEstick，这是一种适合 USB 插座的廉价板(22 美元)。

像大多数供应商一样，Lattice 允许你下载免费的工具来使用 iCEstick。我已经*计划*使用它们。我没有。如果你不想听我对工具的抱怨，请随意跳到下一个标题。

## 晶格的工具链打嗝

还在这里？我不是那种讨厌注册账户的人。所以注册一个 Lattice 账户并不会像某些人那样困扰我。困扰我的是，我从未收到电子邮件确认，也无法进入屏幕要求它重新发送。一击。

我在周末试了试，几天后我收到了 Lattice 的一封短信，说他们知道我试着注册，他们有一个问题，所以我必须重新注册。我照做了，而且效果如我所料。不方便，但是我知道每个人时不时都会有问题。但愿这就是故事的结局。

我对 Lattice 支持 Linux 印象深刻。我下载了一个似乎是 tgz 的文件。我说出现是因为焦油不会碰到它。我检查了这个文件，它看起来像是 unzip 文件，所以我设法将它解压缩到一个扩展名为 tar 的空文件中。有一个问题:这个文件不是一个 tar 文件，而是一个可执行文件。第二击。我把它做成可执行的(是的，我敢说)，然后运行它。果不其然，格子安装程序上来了。

当然，安装程序需要一个许可证密钥，这又是一次去网站与他们共享你的网卡的 MAC 地址。至少它很快就把钥匙送回给了我。安装顺利进行。好兆头，对吧？

我去启动新软件。它找不到我的网卡。稍微在网上搜索一下就发现这个软件只会寻找 eth0 卡。我没有 eth0 卡，但是我有 eth3 卡。不够好。我真的很讨厌重做我的 udev 规则来强迫一个 eth0 进入系统，所以我创建了一个假的网卡，给了它一个 MAC，然后不得不去获得另一个许可证。三振出局。

我决定继续当兵(而不是焊接)。该工具本身并不太糟糕，尽管它实际上只是一些其他工具的简单工作流包装器。我加载了他们的示例 Verilog 并试图下载它。哦。软件不会下载到 FPGA。这是你必须从他们的网站上获得的另一个软件。它支持 Linux 吗？是的，但是它被打包在一个 RPM 文件中。第四击。当然，我可以手动解包一个 RPM 或者使用 alien 来获得一个可能有效的 deb 文件。当然，这是假设它真的是一个 RPM 文件。相反，我决定停下来做我一开始就应该做的事情:使用 iCEStorm 开源工具。

TL；DR:在 Linux 下下载、安装和许可这个工具太难了，所以我放弃了。

# 逐步编程 FPGA

无论您使用什么工具，任何 FPGA 的工作流程基本上都是相同的，尽管具体工具的细节可能会有所不同。有时名字也有点不同。虽然你用 Verilog 写代码，但是 FPGA 有不同的块(不是所有的厂商都称之为块)有一定的功能和方法可以连接。也不是所有的块都必须相同。例如，一些 FPGAs 具有本质上是查找表的块。假设您有一个有一位输出和 16 行的查找表。该表可以生成任何具有 4 个输入和 1 个输出的组合逻辑。同一 FPGA 上的其他模块可能被设置为用作存储器、DSP 计算甚至时钟产生。

一些 FPGAs 使用基于多路复用器的单元，而不是查找表，并且大多数将一些组合逻辑与某种可配置触发器相结合。好消息是，除非你试图从 FPGA 中榨出每一点性能，否则你可能不会关心这些。您编写 Verilog，工具创建一个比特流，下载到 FPGA 或配置器件中(稍后将详细介绍)。

任何 FPGA 开发的一般步骤(假设您已经编写了 Verilog)是:

*   综合–将 Verilog 转换成简化的逻辑电路
*   映射–识别综合设计的各个部分，并将它们映射到 FPGA 内部的模块
*   布局–在 FPGA 内部为设计分配特定模块
*   布线–在需要形成电路的模块之间进行连接
*   配置–将比特流发送到 FPGA 或配置设备

放置和布线步骤通常作为一个步骤完成，因为它类似于 PC 板的自动布线。路由器可能不得不四处移动以获得有效的路由。高级 FPGA 设计人员可能会对不同的工具给出提示，但对于大多数简单的项目，这些工具就足够了。

### 对连接到特定引脚的硬件的限制(或者:它如何知道 LED 在哪里？)

关于摆放还有一点很重要。您是否想知道像 LED1 这样的 Verilog 端口如何映射到 FPGA 上的正确引脚？“放置和布线”步骤可以做到这一点，但需要您对其进行约束。根据您的工具，可能有许多种约束，但我们感兴趣的是一种强制布局和布线步骤将 I/O 引脚放置在特定位置的方法。如果没有这种约束，它将随机分配 I/O，这对于像 iCEStick 这样的现成 PCB 来说是行不通的。

对于我们将使用的工具，您将约束放在一个 PCF 文件中。我做了一个 PCF 文件，定义了 iCEstick 上所有有用的 pin(并不多，正如你们中的许多人在之前的评论中提到的)，它可以在 [Github](https://github.com/wd5gnr/icestick) 上获得。直到最近，如果 PCF 文件中有 Verilog 中没有的内容，这些工具还会抛出一个错误。我要求改变，并且得到了，但是我还没有更新 PCF 文件。所以现在，除了你使用的行之外，所有的都被注释掉了。

下面是约束文件中的几行:

```
set_io LED3 97  # red 
set_io LED4 96  # red 
set_io LED5 95  # green 

```

[![laticebb](../Images/1898a5a394b73240655c71bd6463743f.png)](https://hackaday.com/wp-content/uploads/2015/08/laticebb.png) 您计划使用的每个外部管脚(包括时钟)必须在约束文件中定义。文件中的错误也可能是不好的。例如，将输出路由到直接接地的引脚可能会损坏 FPGA，因此要小心！右图是用我的 PCF 文件配置的(中间的 LED 和最靠近 FPGA 芯片的只是闪烁，图中没有标注)。不过，请记住，您可以根据自己的需要重新路由信号。也就是说，仅仅因为 Verilog 中的 LED1 映射到电路板上的 D1，并不意味着您不能改变主意，将其路由到 PMOD 连接器上的一个引脚。名称不会改变，只是 PCF 文件中的 pin 号会改变。

# 配置 FPGA

不同的 FPGAs 使用不同的技术基础，这可能会影响你如何编程。但这一切都始于比特流(只是二进制配置文件的一个花哨名称)。例如，一些设备有相当于非易失性存储器，你可以像编程 Arduino 一样对芯片编程。通常，这些设备是可重新编程的，但有时不是。除了更简单之外，自带内存的设备通常启动更快。

然而，许多 FPGAs 使用类似 RAM 的存储结构。这意味着在每个上电周期，必须将比特流载入 FPGA。这需要一点时间。在开发过程中，通常只使用 JTAG 直接加载 FPGA。然而，为了部署，微处理器或串行 EEPROM 可以为器件供电(FPGA 通常具有读取 EEPROM 的特殊功能)。

冰棍上的 FPGA 有点奇怪。它基于 RAM。这意味着当您断电时，它的查找表和互连会丢失。该芯片可以读取 SPI 配置 EEPROM，也可以是 SPI 从机。然而，芯片内部还有一个非易失性配置存储器(NVCM)。这与外部 EEPROM 的作用相同，但只能编程一次。除非你想把你的 iCEstick 专用于一个经过良好测试的程序，否则你不会想使用 NVCM。

板上的 USB 接口允许您对 iCEstick 上的配置存储器进行编程，因此，除非您打算将该器件内置于某个设备中，否则您并不真正关心这些细节。但它仍然是很好的理解工作流程:Verilog ➔比特流➔配置 EEPROM ➔ FPGA。

# 冰暴

由于对官方工具感到沮丧，我下载了 [IceStorm 工具](http://www.clifford.at/icestorm/)和相关软件。特别是，您需要的工具有:

*   yosys–合成 Verilog
*   阿拉克尼-pnr-地点和路线
*   icestorm——几个实际处理比特流的工具，包括下载到板上；还提供了阿拉克尼-pnr 理解芯片所需的数据库

你应该按照 IceStorm 页面上的说明来安装东西。我在我的存储库中找到了一些工具，但是它们不够新，所以请节省时间，按照步骤构建最新的副本。

将你的设计编入冰棍需要四个命令行。我假设您有文件 demo.v，并且您已经将仅模拟的数字改回了正确的数字(我们上次讨论过这一点)。arachne-pnr 工具生成一个 ASCII 比特流，所以有一个额外的步骤将其转换为二进制比特流。以下是四个步骤:

*   合成:`yosys -p "synth_ice40 -blif demo.blif" demo.v`
*   地点和路线:`arachne-pnr -d 1k -p icestick.pcf demo.blif -o demo.txt`
*   转换成二进制:`icepack demo.txt demo.bin`
*   配置板上 EEPROM: `iceprog demo.bin`

简单吧？您确实需要 icestick.pcf 约束文件。所有的文件，包括约束文件、demo.v 文件和自动化这四个步骤的脚本都在 [Github](https://github.com/wd5gnr/icestick) 上。要使用该脚本，只需输入:

```
./build.sh demo
```

这将使用 demo.v、demo.txt 等完成所有相同的步骤。

# 尝试一下

一旦板编程，它将立即开始运行。记住，这不是一个程序。一旦电路被配置好，它就会开始做你想让它做的事情(当然，如果你幸运的话)。在下面的图片(和视频)中，你可以看到我的板正在进行测试。我有一些按钮，一边是两个加法器输入，另一边是一个重置按钮。我还在电路板边缘焊接了一些接头。

如果你很懒，你可以只用一个开关或者一根跳线把输入管脚接到 3.3V 或者地。看起来，如果你不连接任何东西，设备引脚通常会很低(但在实际项目中我不会指望这一点)。然而，我确实注意到，如果没有一个电阻将它们拉低(或者一个开关正连接到地)，引脚电压下降时会有一点延迟。在图中，您会看到我将开关置于+3.3V，并将一些下拉电阻接地。该值不应该是关键的，我只是从附近的试验板上抓了一些 680 欧姆的电阻，但这是大材小用。10K 会更聪明，甚至更高也可能行得通。

[![icebb](../Images/40804beab2b5e7f66555a4b3bea54ba3.png)T2】](https://hackaday.com/wp-content/uploads/2015/08/icebb.png)

如果成功了，恭喜你！您已经使用 Verilog 配置了一个 FPGA。还有很多细节需要学习，当然这是有史以来最简单的设计之一。然而，有时候迈出新技术的第一步是最难的，你已经把它抛在脑后了。

虽然你可以用 FPGA 做任何事情，但它并不总是给定项目的最佳选择。开发往往比微控制器开发更难(例如，在 Arduino 上复制这个项目是微不足道的)。此外，大多数 FPGAsss 都非常耗电(尽管我们使用的 FPGA 与一些 FPGA 相比功耗相当低)。当您需要同时执行大量并行逻辑，而不是 CPU 中固有的串行处理时，FPGAs excel 就派上了用场。

FPGAs 在数字信号处理和其他数字处理(如比特币挖掘)中得到大量使用，因为在这些应用中，能够同时完成许多任务非常有吸引力。当然，用 FPGA 构建一个完整的 CPU 是可能的，我个人喜欢用 FPGA 探索不寻常的 CPU 架构。

话又说回来，仅仅因为你可以用集成电路制造收音机，并不意味着用晶体管、电子管甚至方铅矿晶体制造收音机就没有娱乐和教育价值。所以如果你想让你的下一个机器人使用 FPGA 而不是 CPU，不要让我说服你。

[https://www.youtube.com/embed/1CNVsxoLI60?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent](https://www.youtube.com/embed/1CNVsxoLI60?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent)T2】