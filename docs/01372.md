# 让 Arduino 长眠

> 原文:[https://hack aday . com/2012/08/18/making-the-arduino-sleep-the-long-sleep/](https://hackaday.com/2012/08/18/making-the-arduino-sleep-the-long-sleep/)

![](../Images/c346d7f3be71407bd96d04c96a1fa274.png "screen-shot-2012-08-17-at-6-39-55-am")

本周早些时候，我在 kickstarter 上向你展示了他的转向灯头盔。在那篇文章中，我解释说，虽然头盔是一个很好的想法，但我真的对[Naim]告诉我的他的功耗很感兴趣。简而言之，他让他的 arduino 睡眠如此高效，它等待输入的时间可以超过电池的最佳保质期。

在那篇文章之后，[Naim]写信给我，详细介绍了他是如何实现如此高效的系统的。你可以阅读他的全部解释，这里没有改动。

我一直在断断续续地寻找一个特别的应用笔记，我想与你分享，但无论如何也找不到它。看到你的帖子，我咬紧牙关，花了几个小时搜索，终于找到了。该文件是由德州仪器的逻辑设计的[。有趣的部分是图 5(稍后会解释原因)。](http://www.google.com/url?q=http%3A%2F%2Fwww.ti.com%2Flit%2Fan%2Fsdya009c%2Fsdya009c.pdf&sa=D&sntz=1&usg=AFQjCNHNMmMNkd7BQy4Jci3UMZhiqne6zA)

深入了解 Arduino 硬件的低功耗运行

从基础开始。已确保所有 LED 驱动器引脚默认处于关闭状态。移除了所有反馈 LEDS 的负载电阻，我无法像连接到 VCC 那样关闭，因为只要连接电池，就会浪费电能。作为实施说明，我实际上是将 SMT 电阻转向一边，让它们通过一个焊盘相连。如果以后需要，可以很容易地重新安装。

我从一开始就计划不使用板载电压调节器，因为它使用的 quiessent 电流是巨大的 100+ uA。我设计和制造的屏蔽使用较低电流(50mA 对 250mA)调节器，因为我计划仅将其用于控制电子设备和传感器。高电流发光二极管将在没有任何调节的情况下直接在较高电压下运行。因为微处理器和传感器最大消耗 12-15 毫安，而 50 毫安就足够了。

我的系统的预期电流消耗为:

*   电压调节器:~5-6uA
*   ATMega328p: ~1uA
*   CMA3000 (@10Hz w/ wakeup): ~10uA

总计:约 16uA

注:以下测试是在 Arduino Pro Mini 和 Arduino Fio 上进行的，结果相似。自行车头盔原型是建立在 Arduino Fio 之上的。

为了让设备进入低功耗状态，我从 Arduino 示例睡眠草图开始，并浏览了数据手册中的指南，试图找出它消耗如此多功率的原因。当数据手册宣称芯片是时，Arduino 使用大约 420uA

我已经绕过 Arduino 电池输入端，将其连接到超低静态电压调节器的输入端，并将其输出端直接连接到 Arduino VCC。当前系统功耗上升至约 155uA。WTF？？？

接下来，我寻找 I2C 和/或 SPI 的数字线路上的上拉信号。不仅仅是配置为输出并以错误方式驱动的引脚，还要查看哪些弱上拉是有意(或无意)使能的。我见过很多 Arduino 开发者这样做。如果一个引脚的输出值配置为高，当它切换到输入时，它不只是切换到高阻抗输入。如果设置了数字输出寄存器，则在该引脚上使能弱上拉(对于 AVR Rpu = 20-50kω)。如果外设随后决定将该输入端的信号设为低电平，系统会突然看到电流的 VCC/Rpu 增加，如果不使能上拉，则不会出现这种情况。每当我看到一个系统的 VCC/Rpu 偏离其睡眠电流的某个奇怪倍数时，我会查找不应使能的输入上拉。在这种情况下，对于 3.3V 供电轨，上拉会导致 60-150uA 的电流消耗。审查了我所有的代码，探测了引脚，没有发现任何配置错误。高兴的是我没有搞砸任何事情，但不高兴的是我仍然有 140 ua(150 ua)消失在以太中，吸干我的电池。

然后，我开始寻找一些可能导致这种情况的更模糊的故障类型。我发现的其中一件事(后来参加了一个如何解决的速成班)是器件的“数字输出引脚反向供电”，有时也称为“引脚供电”或“端口供电”。现在回到[用逻辑](http://www.google.com/url?q=http%3A%2F%2Fwww.ti.com%2Flit%2Fan%2Fsdya009c%2Fsdya009c.pdf&sa=D&sntz=1&usg=AFQjCNHNMmMNkd7BQy4Jci3UMZhiqne6zA)设计。参见图 5，如果具有数字 I/O 的芯片关断(VCC 断开)，则从外部向该 I/O 施加电压，该电压会导致输入端的 D1 或输出端的 D3 反向偏置，允许电流流动，并向芯片的内部 VCC 提供该电压(减去二极管压降)。然后奇怪的事情就开始发生了。大多数当前的数字芯片可以轻松地在 1.8V 电压下工作(一些较新的芯片可以在 0.9V 电压下工作)，因此，如果外部引脚以 3.3V 电压驱动，并且有足够的电流可以偷偷流过二极管，则器件将很高兴地在内部获得的 2.7-3.0V 电压下工作。我用一个永远不会关闭和复位的外设艰难地发现了这一点。处于边缘，通过反向供电启动时电流太大，但一旦运行，就会很高兴地通过反向供电继续运行。给它 3.3V 的电压，它就打开了，把它拿走，它就继续运行。超级混乱，因为可以打开它，但不能关闭？？？

虽然调节器的输出不是数字 I/O 引脚，但我开始认为输出电路可能仍有问题。因此，我切断了 Fio 上调节器的输出走线(我刚刚将调节器从 Pro Mini 上完全移除)，电流消耗降至 34uA。这让我的睡眠电流减少了 10 倍多，电池寿命增加了 10 倍。用完 1900 毫安时的 AA 电池后，它应该会休眠 6-7 年，仍在进行 10Hz 采样以检测运动。在我的原型中，9V 电池的额定功率为 590 毫安时，这还不到两年。

在这一点上，我带着 kickstarter 向前迈进，因为我可以达到我设定的人生目标。电流仍然是我的包络计算的两倍左右，但不会是一个表演停止。它仍然压在我身上，在这个系统中有一些东西，我不知道它是如何发生的，为什么会发生。就在昨天我又在想这个的时候，发现了星火趣味教程[低功率地冒险](http://www.google.com/url?q=http%3A%2F%2Fwww.sparkfun.com%2Ftutorials%2F309&sa=D&sntz=1&usg=AFQjCNEjYkRnXF3XNR8neKsX1ABkfTjBqg)。虽然我在整个过程中独立完成了相同的初始步骤，但我没有达到查看欠压检测(BOD)和更换保险丝的程度。鉴于 BOD 消耗 15-20uA，我现在对我的 34uA 睡眠非常满意，这意味着随着 BOD 的禁用，我应该在 14-19uA。:)适用于 1900 毫安时电池，可提供 10-12 年的睡眠时间。这远远超过了普通碱性电池 5-7 年的保质期。任何时候，当我超过电池的储存寿命和接近电池的自我耗尽时间时，我都非常高兴。:)