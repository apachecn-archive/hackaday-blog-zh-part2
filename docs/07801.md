# 逆向工程卡普空的加密 CPU

> 原文:[https://hack aday . com/2014/12/12/reverse-engineering-capcoms-crypto-CPU/](https://hackaday.com/2014/12/12/reverse-engineering-capcoms-crypto-cpu/)

有一些老的卡普空街机游戏——庞，凯迪拉克和恐龙，以及积木——与投币游戏世界中的其他游戏不同。是的，它们很老了，但让这些游戏与众不同的是它们运行的 CPU。这些游戏的硬件大脑是歌舞伎，Z80 CPU 有一些额外的安全功能。卡普空为什么会生产这种东西？打击盗版者，盗版者会拷贝和复制街机游戏，而不向原发行商支付版税。这是街机历史上有趣的一部分，但也是策展人的一个问题:这种安全性已经杀死了许多街机，[导致【Eduardo】逆向工程和记录歌舞伎的全部细节](http://arcadehacker.blogspot.com/2014/11/capcom-kabuki-cpu-intro.html)。

虽然普通的 Z80 CPU 有一个引脚专门用于刷新 DRAM，但歌舞伎将这个引脚重新用于芯片上的安全功能。这个引脚低，歌舞伎是一个标准的 Z80。当引脚被拉高时，它充当安全特性的电源输入。安全性——只有少量存储在内存中——是由电池支持的，一旦电池断开，芯片就会失效，从而终止游戏。

[将 Kabuki 插入一台旧的 Amstrad CPC 6128](http://arcadehacker.blogspot.com.es/2014/11/capcom-kabuki-cpu-part-1.html) 中，没有拉高安全销，允许【Eduardo】测试所有 Z80 指令，并且没有发现任何意外；歌舞伎完全兼容地球上所有其他 Z80。确定歌舞伎如何在安全别针被拉高的情况下工作是一个更困难的任务，但是[Mame 团队已经确定了。](https://github.com/mamedev/mame/blob/master/src/mame/machine/kabuki.c)

Kabuki 内部的安全系统通过一系列的位交换、循环移位、xor 来工作，如果字节是操作码或数据，每个翻译都不同。歌舞伎中安全的编码和解码过程很好理解，但是[爱德华多]有几个未解的问题。歌舞伎停电后，内存内容——特别是位交换、地址和 XOR 密钥——消失了，会发生什么？工厂里的歌舞伎是怎么编排的？有没有可能对这些安全密钥进行重新编程，让一个歌舞伎可以玩不是为它制造的游戏？

[Eduardo]认为能够加密新的有效代码是运行用不同密钥加密的代码的第一步。为了测试这个理论，他为 Capcom 硬件写了一个简单的“Hello World ”,它在 Mame 下工作得非常好。虽然演示在 Mame 下工作得很好，但当烧录到 EPROM 上并放入真正的 Capcom 硬件时，它就不工作了。

这个故事到此结束，至少目前是这样。新的加密代码是有效的，Mame 运行加密代码，但在[Eduardo]或其他人能够找出歌舞伎里面的任何附加配置设置之前，这个项目在轨道上是死的。[Eduardo]将于下周某个时候回来，再次将歌舞伎拆开，试图揭开这个处理器工作原理的神秘面纱。