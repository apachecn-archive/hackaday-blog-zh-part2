# 利用 Excel 宏密码漏洞破解 Dridex 恶意软件

> 原文：<https://hackaday.com/2015/03/20/breaking-dridex-malware-with-excel-macro-password-exploit/>

[Ronnie]最近在他的[恶意软件解构冒险](http://hackaday.com/2015/03/06/decoding-zeus-malware-disguised-as-a-doc/ "Decoding Zeus malware")中发布了[新章节](http://phishme.com/dridex-code-breaking-modify-the-malware-to-bypass-the-vm-bypass/ "Breaking dridex malware")。这一次，罪魁祸首是被感染的 Excel 电子表格文件。的。xls 文件附在一封声称与退税有关的网络钓鱼电子邮件中。随着纳税季的全面展开，这种类型的网络钓鱼邮件很可能会被没有经验的用户打开。

[Ronnie]将文件保存到虚拟机上，以防止他的真实工作站被感染。然后他在 Excel 中打开它，注意到它立即试图运行宏。宏本质上是在电子表格文件内部运行的 visual basic 脚本。您可以使用它来实现简单的自动化、单元格格式化，或者执行更复杂的任务，如访问外部网站和获取信息。这种恶意软件侧重于后者。

[Ronnie]使用 alt + F11 快捷键查看宏。不幸的是，攻击者有密码保护他们。不知道密码就无法查看宏代码。幸运的是，他学到了一个惊人的简单技巧来完全绕过宏密码。他打开了。xls 文件并找到三个键；CMG、DPB 和 G. [Ronnie]随后创建并保存了一个新的空白。xls 文档和密码用自己的密码保护宏。他也在 Notepad++中打开了这个新文件，并找到了这三个相同的键。他将新文件中的密钥复制到旧文件中，并保存了旧文件。这有效地将恶意软件文件的密码更改为他为新文件设置的新密码。这是一个很好的技巧，显然只对老年人有效。xls 格式，而不是更新的。xlsx 格式。

加载宏后，[Ronnie]很快注意到大部分代码都被混淆了，难以分析。然而，有三个命名模块引用了可能的沙盒规避技术。恶意软件首先调用这些函数来检测虚拟机或其他类型的沙箱的存在。如果它什么也没检测到，那么恶意软件程序的其余部分被解码并执行。[Ronnie]删除这些检查，然后执行宏来验证他的更改是否有效。

下一步是尝试查看解码后的指令。解码后的乱码被保存到一个变量中。[Ronnie]查看变量内容的最简单方法是让程序创建一个弹出框，显示该变量的内容。在进行这一更改并再次运行程序后，他能够确切地看到恶意软件在做什么。该代码实际上调用了 Powershell，从互联网上下载了一个文件，然后提取并执行该文件。在完整的文章中，[Ronnie]甚至更进一步，下载并分析了可执行文件。