# 嵌入艾略特:I2C 巴士扫描

> 原文:[https://hack aday . com/2015/06/25/embed-with-Elliot-I2C-bus-scanning/](https://hackaday.com/2015/06/25/embed-with-elliot-i2c-bus-scanning/)

许多优秀的 IC 使用 I2C 进行通信，但是调试一个不起作用的 I2C 设置可能是不透明的，尤其是如果你刚刚开始使用协议/总线的话。在调试 I2C 系统时，I2C 总线扫描仪是很有帮助的第一步。我认为应该出现的所有设备都在那里并有响应吗？它们都以我尝试运行的总线速度工作吗？如果你身边有一个 Arduino 或巴士海盗，你只需几秒钟就可以扫描你的 I2C 巴士，并回答这些问题。

## 真相:I2C 简介

[I2C](https://en.wikipedia.org/wiki/I%C2%B2C) 是一种双线(加地)通信总线和协议。物理层只有两条信号线:一条是由主机控制的时钟线(SCL ),另一条是由主机或被寻址的从机控制的数据线(SDA)。当时钟为高电平时，总是在 SDA 线上读取数据，当时钟为低电平时，会建立一个新值。此规则的两个例外是停止和开始信号，此时允许主机在时钟仍为高电平时升高和降低数据线。因为这种变化不应该在数据传输期间发生，所以停止和开始信号很容易被检测到。

[![i2c_timing](../Images/b7d708473442e53c1eba2342b6f9ac89.png)T2】](https://hackaday.com/wp-content/uploads/2015/06/i2c_timing.png)

所有数据都以 8 位数据包的形式发送，每个数据包都由接收方(无论是主机还是从机)确认。为了开始对话，主机发送起始信号，然后发送它想要与之对话的从机的 7 位地址。主机第一个包中的第八位告诉从机主机是否要发送更多数据(“写”命令，0)或者主机是否正在请求从从机返回数据(“读”值，1)。

8 位发送完毕后，从机需要通过拉低数据线来应答接收。该确认信号正是 I2C 总线扫描软件需要寻找的，以便检测总线上具有给定地址的芯片。

当然，对 I2C 来说，还有更多复杂的细节。例如，可以进行传输的时钟速度有一个完整的范围:从默认的 100kHz 数据速率，到 400kHz“快速模式”，1MHz“快速模式增强”，直到 5MHz“超快速模式”。(我们屏息以待 10MHz 的“超级超级、真的真的快模式”。)而且由于总线是由 SCL 线计时的，几乎任何较慢的数据速率，只要达到允许的最大值，都可以正常工作。

[![i2c_master_slave_circuit](../Images/20402b2f8d79d8d55d5287bbef73ed84.png)](https://hackaday.com/wp-content/uploads/2015/06/i2c_master_slave_circuit.png) 通过上拉电阻将物理线路上拉至逻辑高电压电平，通过下拉线路将设备信号拉低。这意味着电压转换可能有点模糊，尤其是长距离传输或线路本身容性耦合到电路的其他情况。这些物理因素将决定 I2C 总线上发送信号的速度，您可能需要微调特定系统中的上拉电阻。

在 I2C 总线上，出现问题的其他方式多得惊人，因此能够从一开始就开始调试非常好——从机是否以我发送的速度收到了我的第一个(地址)数据包？因此，I2C 扫描仪的效用。

## 扫描仪

然后，I2C 总线扫描器的第一次切割可以通过循环通过所有 127 个可能的从设备地址，并检查它们是否应答来进行。接下来，如果您认为可能会遇到信号上升和下降时间的问题，您可能希望以不同的总线速度重新运行相同的测试。最后，我们从来没有看到这种实现，它可能很酷，有一个共同的 I2C 从设备地址的数据库，使扫描仪本身可以报告它找到了特定的芯片。

对于 t [![i2c_scan](../Images/3371a14d90b175de0d4d184063756453.png)](https://hackaday.com/wp-content/uploads/2015/06/i2c_scan.png) 何 Arduino 来说，我们见过的最有特色的扫描仪是贴在 Arduino 论坛上的[，代码](http://forum.arduino.cc/index.php?topic=197360)[托管在 Github](https://github.com/RobTillaart/Arduino) 的“sketches/MultiSpeedI2CScanner”文件夹中。它实际上做了我们在一个简单的扫描仪中想要的一切:以不同的速度扫描整个总线，并通过串行端口很好地绘制出结果，供您在计算机上阅读。它被配置为在重启时进行全面扫描。键入“ps”仅打印找到的设备并开始扫描。嘭！

Arduino 扫描仪的一个警告是，如果你忽略了在 SDA 和 SCL 线上连接上拉电阻(我们绝不会！)扫描仪以 800kHz 运行时似乎会挂在某个地方。我们怀疑它在等待成为总线主，只是卡住了；我们想知道为什么 Arduino“twi . c”库中的 twi_writeTo()函数没有超时。(有人猜得准吗？)其他速度模式工作正常，在 SDA 上增加一个 10k 上拉电阻后，一切又恢复正常。

很自然，总线盗版者(串行通信的瑞士军刀)会进行 I2C 扫描。它一次只运行一个频率，但它足够快，你可以在很短的时间内一步步完成。它有一个怪癖，或者也许是一个特征；它将读/写位视为地址的一部分，因此它将双向测试每个芯片。进入 I2C 模式，设置所需的速度和上拉/功率选项，最后键入“(1)”进行选项 1: 7 位地址搜索。您应该会看到所有在总线上响应的设备都为您列出来了。

[https://www.youtube.com/embed/UWc7f-Unni4?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&start=162&wmode=transparent](https://www.youtube.com/embed/UWc7f-Unni4?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&start=162&wmode=transparent)T2】

如果你知道你正在使用的芯片，编写你自己的代码来进行扫描也是惊人的简单。大多数微控制器的专用硬件 I2C 接口会在特定的寄存器中报告错误代码。如果你能弄清楚如何测试“发送地址和数据方向包后没有确认”错误，代码本身就很好写了。

## 更进一步

一旦您验证了基本功能——当以期望的速度寻址时，从机会做出响应——并且您的 I2C 设置仍然不工作，您就可以调试更难的问题了。您可能还想做其他测试，但不幸的是，它们都很快进入从属设备特定的命令集。例如，许多设备会收到一个命令，要求用一个已知的设备 ID 或默认寄存器的内容或类似内容进行回复。这些对于确保多字节命令按预期工作很有用。

如果您怀疑信号上升或下降不够快，可能是因为您在上面的扫描中看到芯片以低速响应，而不是以高速响应，您将需要一个示波器来实际探测线路上的模拟电压。或者尝试较低值的上拉电阻来加速上升沿，然后再次测试。

在多主 I2C 总线上，更难捕捉或不经常发生的小故障变得很难很快跟踪。但是首先验证简单的东西是否工作——所有部件都在您认为它们所在的地址上——可以让您走上正确的道路。

祝你的 I2C 项目好运！如果你有任何其他有用的 I2C 调试工具或策略，欢迎在评论中讨论。