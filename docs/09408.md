# 嵌入埃利奥特:我们不需要讨厌的 RTC

> 原文:[https://hack aday . com/2015/07/01/embed-with-Elliot-we-dont-need-no-stinkin-rtcs/](https://hackaday.com/2015/07/01/embed-with-elliot-we-dont-need-no-stinkin-rtcs/)

很多微控制器项目需要一些挂钟时间的感觉。无论你是在制造(又一个)疯狂的时钟，记录数据，还是只是倒数茶泡剩下的时间，获得人类时间是关键。

最简单的解决方案是获取实时时钟(RTC) IC 或模块。有很好的理由这样做，因为长时间保持准确的时间是非常困难的。每天一秒是 1/86，400 或大约百万分之十一点五(ppm)，如果没有严肃的工程设计，要超过二十 ppm 是很棘手的。

![Chronodot uses a Maxim TXCO](../Images/d338c707af90d5ab28b9b442b6955144.png)

[Chronodot](http://docs.macetech.com/doku.php/chronodot_v2.0) uses a Maxim TXCO

像 [Chronodot](http://hackaday.com/2009/10/27/parts-chronodot-rtc-module-ds3231) 中使用的 [Maxim 的 DS3231](http://www.maximintegrated.com/en/products/digital/real-time-clocks/DS3231.html) 这样的优秀 RTC ICs 可以做到这一点。他们使用温度校正逻辑和晶体振荡器来获得百万分之五的精度，或者每天不到半秒。他们甚至有内部日历功能，处理闰年和星期几等等。缺点是成本:单个温度补偿 RTC 的成本约为 10 美元，这可能会超出一些需要多个模块的简单黑客或安装的预算。但是有一个非常合适的替代方案。

我们所寻求的是一种中间道路:一个微控制器项目的墙时间解决方案，不会打破银行(免费将是理想的)，但在成熟的环境条件下长期表现良好。你办公室里用来做时钟的那种东西。我们将首先看一看“显而易见”的竞争者，一个普通的晶体振荡器解决方案，然后继续看一些实验性的和棘手的东西，但从长期来看是免费的和基本上完全准确的:使用电力线频率作为标准。

## 水晶城堡

![Closeup shot of a printed circuit board.](../Images/424c8afbe4934f55fafe327467e56e9d.png)

Typical can crystal

如果你不需要非常高的精度，也许你每月可以增加或减少一两分钟，这没什么大不了的，那么有一大堆便宜的[晶体振荡器](https://en.wikipedia.org/wiki/Crystal_oscillator)解决方案将为你工作。事实上，你现在甚至可以用它来为你的微控制器计时:Arduino 就是这种情况，它有一个正常外观的晶体，可能适合 10-50 ppm 左右。

晶体振荡器的问题是温度。虽然任何给定的晶体在单一温度下可以保持稳定的频率在百万分之几的范围内，但是当温度改变时，该频率会改变。事实上，如果你想要非常高的稳定性，你可以通过把它放在一个小的绝缘“烤箱”中来保持晶体常数的温度。

这种温度依赖性是制造商的规格在给定温度范围内以 ppm 给出的原因。使用普遍存在的 32.768 kHz 晶体的简单 RTC 单元也是如此。但是即使频率相当稳定，比方说你把电路放在一个气候可控的室内建筑里，晶体振荡器也不一定精确。也就是说，在某些温度下，8.000 MHz 晶振的频率可能是非常稳定的 8.001 MHz。如果你想要很高的精度，你需要校准它。

请注意，许多微控制器中的内部 RC 振荡器也是如此，尽管情况更复杂，因为频率取决于工作电压和温度。如果你能保持温度和电压恒定，你也能从 RC 振荡器获得不错的性能。

校准在概念上并不难，只是不稳定振动器中的一个难点。如果你有耐心和一个好的时间源，你可以通过运行晶体时钟 24 小时或更长时间，计算出你的微控制器运行快或慢多少秒，并在代码中相应地调整:根据需要定期增加或减少闰毫秒，从而获得非常好的室内使用结果。如果你在几天内重复这种校准，可能选择一个热天或一个冷天，除了一点固件开销之外，你几乎没有额外的成本就可以获得相当好的全年精度。

## 电力线时间

但是所有这些校准和温度控制都很麻烦。如果必须校准多个器件，情况会更糟。让别人帮你准确计时要好得多。一个可以同时向你们所有设备发送定时信号的人。比如你当地的电力公司。

在世界上的许多地方，交流电运行在一个非常好的 50 或 60 赫兹的频率上。虽然一天中的时间可能会有很大变化，这取决于什么样的发电机为你提供电力以及系统中的总需求有多少，但电力公司试图保持一个[精确得离谱的长期平均频率](http://www.leapsecond.com/pages/mains/)。以至于从长远来看，电力线驱动的时钟在准确性方面可以与最好的 TCXOs 相媲美。

![IMG_20150629_202827](../Images/84e1403a4109a6b593b26be72f344f31.png)为了获得可靠的壁式时间解决方案，使用变压器将壁式电压降低到微控制器可以处理的水平是可行的方法。如果你已经在壁式电源上运行你的项目，你甚至可以打开机箱，直接接入低压交流电，因为它来自变压器。此外，您可能希望将产生的 50 Hz 或 60 Hz 正弦波通过低通滤波器，以消除电力线噪声，从而获得干净整洁的低高逻辑转换。也许甚至可以用施密特触发器来调整正弦波。

但是如果我们更进一步呢？我们经常注意到，电力线的 50Hz(欧洲标准)嗡嗡声会进入任何未连接的高阻抗输入，那么为什么不将噪声视为信号，并尝试运行辐射电力线的微控制器实时时钟呢

我们将一个鳄鱼夹连接到 AVR Mega168 的输入引脚，并使用芯片的正常输入调理电路代替任何外部器件。当引脚上的电压为高电平时，输入读数为 1。完成了。微控制器逻辑输入具有足够高的输入阻抗，引脚上施加的电压会随着接收到的电力线噪声信号来回摆动。

[![scope_23](../Images/99d5b4aaa7f72f0bbfdb92368f31864e.png)](https://hackaday.com/wp-content/uploads/2015/06/scope_23.png) 逻辑转换相当混乱，看看示波器上“天线”的输出就知道为什么了。我们在代码中进行了快速和肮脏的去抖动；我们只是在第一次上升跃迁后等待 1 微秒，以消除高频噪声的影响。

解决了这个问题，我们得到了一个 LED 闪烁，看起来像是一秒钟的间隔。但是电力线信号到底有多精确，它作为时钟是否足够可靠？

为了找到答案，我们让微控制器通过 USB/串行连接每秒钟向我们的笔记本电脑发送一个字节。在笔记本电脑端，Python 例程接收传入的字节，并在它到达时记录系统时间。现在，笔记本电脑的内部时钟也不完全准确，所以笔记本电脑被同步到 NTP 服务器。

使用 GPS 的每秒脉冲输出作为参考时间源可能更好，但我们在办公室里接收 GPS 信号很差。应该都够好了。但请记住，电力线时钟信号和笔记本电脑时间之间的差异必然是两部分误差的总和。

[![clock_time_vs_difference_discrepancy](../Images/6b9edbf4f4469e856e832e5419c48ed9.png)](https://hackaday.com/wp-content/uploads/2015/06/clock_time_vs_difference_discrepancy.png) 你可能会认为接收电力线噪声“信号”是这种方法的致命弱点。毕竟，天线由一个随意长度的鳄鱼夹组成，就挂在我们的桌子上，但它似乎工作得很好。在 50Hz 时，一个周期是 20 毫秒，因此错过的周期将表现为 20 毫秒的计算机-微控制器时间差异的突然变化。

在我们让实验运行的 24 小时内，我们只看到了五次这样大小的跳跃。每天损失 100 毫秒是 1.16 ppm，因此，即使这种完全隔离的天线也不是这里的限制因素。

[![clock_time_vs_discrepancy](../Images/13dc3ce5359013a6986faf8f3f530bf2.png)](https://hackaday.com/wp-content/uploads/2015/06/clock_time_vs_discrepancy.png) 我们所看到的是，围绕着我们最初的同步开始，有许多逐渐的来回移动。(注意，时间同步误差中的“零”没有意义；这只是我们的笔记本电脑的时钟和微控制器的时钟之间的最初差异。)

电力线时间通常在白天慢几秒钟，在晚上大家下班回家时最糟糕，但在晚上发电机负载较轻时会赶上。在这个例子中，时钟在早上快了 3.6 秒，在晚餐时间慢了 2 秒。只要电力公司最终达到平均每天 4，320，000 个周期，这是他们的目标，时钟将全年保持准确。

时钟速度随时间的缓慢变化意味着，如果你需要每分钟都非常精确的计时，电力线方法可能不适合你。

另一方面，如果你只是需要一个微控制器来精确计算一天中的秒数，那么使用接收到的电力线噪声似乎是近乎理想的。即使时钟在大部分时间跑得快或慢，如果公用事业公司做好自己的工作，它的平均水平应该足以击败一个良好的长期漂移 TCXO。

现在你有了:一个由电力公司供电的精确时钟，由挂在桌子边上的鳄鱼夹和几行代码制成。

使用辐射电力线噪声而不是专用 RTC 芯片的主要缺点是缺乏电池备份，而目前大多数 RTC 都有电池备份。当然，当墙上的电源断电时，它就会坏掉。对于一个全功能的日历应用程序，你必须自己处理闰年之类的事情，但是有针对那个 [(AVR 版本)](http://www.nongnu.org/avr-libc/user-manual/group__avr__time.html)的[标准库](https://en.wikipedia.org/wiki/C_date_and_time_functions)。

## 有问题吗？

你们有人用电力线频率计时吗？你觉得怎么样？有什么技巧或诀窍吗？它在美国仍然有效吗？你能想到更好的天线设计或输入调理电路来改善我们的结果吗？请在评论中发表。